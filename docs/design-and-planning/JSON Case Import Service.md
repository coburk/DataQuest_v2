## ⚙️ Implementing the JSON Case Import Service

The **JSON Import Service** is a crucial component of the **`CaseManager`** within the Core Logic Layer. Its primary responsibility is to safely load the validated `CasePlan` (generated by the **Case Planner Agent** or provided by an instructor) from a JSON file into the application's memory. This process ensures the application has the necessary `StorySteps` and `CanonicalQueries` to guide the student and enable the  **Query Tutor Agent** 's functionality.

This task is necessary to fulfill the requirements of **US-07f** (Load cases from UI).

---

### 1. Technical Requirements and Strategy

| **Requirement**     | **Strategy**                                                                | **C# Implementation Detail**                                                                                                                |
| ------------------------- | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Data Integrity**  | Must ensure the loaded JSON adheres to the expected**JSON Case Schema** .   | Use the `System.Text.Json`namespace for high-performance JSON deserialization.                                                                  |
| **Error Handling**  | Must fail gracefully if the file is missing or the JSON is invalid/malformed.     | Implement `try-catch`blocks specifically targeting `FileNotFoundException`and `JsonException`.                                              |
| **Type Safety**     | Convert the JSON data into structured C# objects that the `CaseManager`can use. | Create a set of C#**Plain Old CLR Objects (POCOs)**that directly mirror the `CasePlan`JSON schema (e.g.,`CasePlan`,`StoryStep`,`Person`). |
| **Agent Readiness** | Must confirm the loaded case is marked as solvable.                               | The deserialized `CasePlan`object must check the `IsSolvable`property, ensuring only validated cases are used.                                |

---

### 2. High-Level Service Workflow

The `JsonCaseImportService` will follow these steps when triggered by the UI (e.g., the student selects a case file):

1. **Select File:** The service prompts the user (or reads a path from configuration) for the location of the `CasePlan.json` file.
2. **Read File:** The service attempts to read the contents of the file into a string.
3. **Validate Structure:** The service attempts to **deserialize** the JSON string into the master C# **`CasePlan`** object.
4. **Validate Logic:** The service checks the `IsSolvable` boolean property within the deserialized `CasePlan`. If `false`, the case is rejected and logged.
5. **Load to Manager:** If both structural and logical validation pass, the final C# `CasePlan` object is passed to the **`CaseManager`** component.
6. **Log Activity:** Record the success or failure of the import process in the application logs.

---

### 3. C# POCO Structure Example

The following C# class structures mirror the JSON Case Schema, ensuring the data is easily accessible and strongly typed for the core logic and agents:

**C#**

```
// Represents the entire case document (the root JSON object)
public class CasePlan
{
    public string CaseID { get; set; }
    public string CaseTitle { get; set; }
    public string InitialPrompt { get; set; }
    public bool IsSolvable { get; set; } // CRITICAL for ensuring case integrity
    public List<StoryStep> StorySteps { get; set; }
    public List<Person> Persons { get; set; }
    // ... other top-level properties (Conclusion, Contradictions, etc.)
}

// Represents a single investigative step
public class StoryStep
{
    public int StepID { get; set; }
    public string StepPrompt { get; set; }
    public string CanonicalQuery { get; set; } // Used by Query Tutor (US-05)
    public string ExpectedValue { get; set; }
    // ... other properties (ErrorContext, EvidenceType)
}

// Represents a person involved in the case
public class Person
{
    public int PersonID { get; set; }
    public string Name { get; set; }
    public string Role { get; set; }
}
```

By strictly implementing this service, the application ensures that the core learning narrative is always derived from verified, structured data, providing a stable foundation for the AI agents to operate.
