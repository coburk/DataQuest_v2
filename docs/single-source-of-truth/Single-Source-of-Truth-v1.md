# DataQuest: SQL Detective - Single Source of Truth (SSOT)

---

This document aggregates the core design decisions, architecture, and specifications into one centralized reference.

* Version: 1.0
* Status: Phase 1 Implementation Ready
* Primary Tech Stack:
  * C#
  * .NET 9
  * WinForms
  * Microsoft SQL Server
  * Ollama (Local LLM)
  * Model Context Protocol (MCP)

Development for DataQuest follows a defined AI Collaboration Protocol that standardizes how AI coding assistants (ChatGPT, Claude, GitHub Copilot) are used. This protocol enforces architecture alignment, MCP and SSOT constraints, and consistent code quality. The protocol and its prompt templates are documented in `AI-Collaboration-Protocol-DataQuest.md` and referenced in the Master SSOT Index under “Development Workflow & AI Collaboration.”

---

1. **Project Epic & Executive Summary**
   * DataQuest: SQL Detective is an AI-assisted learning application designed to transform SQL education into a dynamic, gamified investigative experience.
   * By shifting the perception of SQL from a rigid programming language to a forensic tool, students operate as lead detectives solving narrative-based mysteries.
   * The system utilizes a local, multi-agent AI architecture to generate cases, validate logic, and provide Socratic tutoring, ensuring privacy and offline capability for classroom environments.

---

2. **Problem, Purpose, & Objectives**
   * The Problem
     * Traditional SQL education often focuses on syntax memorization, resulting in students who can write queries but lack critical thinking and data reasoning skills.
     * Learners struggle to connect technical proficiency with real-world problem-solving.
   * The Purpose
     * To bridge the gap between technical skill and analytical thinking by creating an environment where every SQL query is a question asked of the evidence.
     * The system frames learning as an investigation: Plan (the inquiry), Verify (the execution), and Tutor (the feedback).
   * Core Objectives
     * Develop an AI-driven platform that turns query practice into interactive investigations.
     * Implement 4 specialized AI Agents
       * Database Agent
       * Case Planner Agent
       * Query Tutor Agent
       * SQL Enforcer Agent
     * Integrate a Model Context Protocol (MCP) for secure, read-only database access.
     * Gamify Learning through narrative "cases" rather than abstract problem sets.
     * Deliver Socratic Tutoring that guides reasoning rather than providing direct answers.

---

3. **Architecture Overview**
   * High-Level Architecture
     * DataQuest utilizes a modular, layered architecture designed for local execution.
   * Presentation Layer:
     * C# WinForms UI (Schema Browser, SQL Editor, Results Grid, Hint Panel).
   * Application Layer:
     * AgentOrchestrator (traffic controller for AI)
     * CaseManager (state management)
   * AI Agent Layer: Four specialized agents that interface with the backend.
   * Infrastructure Layer:
     * OllamaInterface: Manages local LLM inference.
     * MCP Client: Manages JSON-RPC communication.
     * Local Backend: MSSQL Database and C# MCP Server.
   * System Context
     * The application sits between the Student and the Local Infrastructure.
     * The Agent Orchestrator manages the flow of data between the User Interface and the AI Agents, routing requests to the Local LLM (for reasoning) or the Database MCP (for data retrieval).

---

4. **AI Agent Definitions**

   The system relies on four core agents operating within a Plan-Verify-Tutor cycle.

   | Agent Name         | Role                 | Core Responsibility                                                                                                                              |
   | ------------------ | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
   | Database Agent     | The Technical Expert | Translates raw database schema (tables, columns, foreign keys) into natural-language explanations to help students understand the data structure |
   | Case Planner Agent | The Storyteller      | Analyzes schema to generate CasePlan JSON objects containing narrative steps and canonical queries. It does not validate its own work            |
   | Query Tutor Agent  | The Mentor           | Compares student query results against canonical results. If the query fails, it generates Socratic, schema-grounded hints to guide the student  |
   | SQL Enforcer Agent | The Logic Checker    | Validates the solvability of cases generated by the Planner. It executes canonical queries to ensure data integrity and rejects broken cases     |

---

5. **Model Context Protocol (MCP) Architecture**
   * **Role:** The Secure Data Gateway & Middleware.
   * **Implementation Status:** ✅ Integrated (Phase 2 Complete) via `DataQuest.MCP` project
   * **Definition:** The MCP in DataQuest is a **local C# middleware service** that implements the JSON-RPC 2.0 standard. It acts as the mandatory security boundary between the AI Agents (running on Ollama) and the Local SQL Server. It ensures agents cannot hallucinate destructive commands (DROP/DELETE) by restricting access to specific, pre-defined "Tools"**.**
   * **Core Components (The Technical Truth):**
     1. ****The MCP Server (**  **MSSQLMCPServer****):
        * A C# service that manages the actual SQL connection, executes queries via ADO.NET, and serializes results into JSON.
     2. **The Client Wrapper (****ISqlMcpClient****):**
        * A strongly-typed C# interface within the main application that wraps JSON-RPC calls, providing methods like `ExecuteQueryAsync` and `GetSchemaAsync` to the `AgentOrchestrator` and `DatabaseManager`.
     3. **The Transport:** Uses standard input/output (stdio) for secure, offline, local inter-process communication, avoiding the need for exposed network ports.
   * Exposed Agent Tools (The API Contract):
     * The MCP exposes exactly four tools to the AI Agents. Agents *cannot* perform any action outside these four functions:
       * `execute_sql`: Safely executes a SELECT query (Read-Only enforced).
       * `describe_schema`: Returns table schema, columns, and foreign keys for reasoning.
       * `list_tables`: Returns a list of available tables in the case context.
       * `get_column_info`: Returns detailed metadata for specific columns.
   * **Critical Design Documents (The Source of Truth):**
     * **Architecture & Design: `docs/design-and-planning/MCP-Integration-Design.md` (Defines the 3-layer architecture and tool definitions)**.
     * **Implementation & Wrappers:**`docs/design-and-planning/MCP-Integration-Complete.md` (Details the `ISqlMcpClient` and `DataQuest.MCP` project structure)**.**
     * **Security & Protocol:**`docs/design-and-planning/MCP-Integration-Possibilities.md` (Explains the JSON-RPC security boundary and readonly enforcement).

---

6. **Database Schema**
   * Design Decision: The system uses a Traditional Separate Tables approach.
   * JSON and polymorphic designs are strictly hidden from the student view to ensure educational clarity.
   * Core Investigative Tables
     * Cases: Definition of the investigation scenario.
     * Persons: Suspects, witnesses, and victims involved in the case.
     * Locations: Physical places where evidence or events occur.
     * Evidence: Physical items linked to cases and locations.
   * Tier-Specific Tables (Progressive Complexity)
     * Tier 1: BadgeAccess, ParkingLotAccess (Simple SELECT/WHERE).
     * Tier 2: Incidents, CommunicationRecords (JOINs/Aggregation).
     * Tier 3: WitnessStatements (Data Quality/Contradictions).
     * Tier 4+: TransactionLogs (Complex Analysis).
   * Tutoring Control Tables (Hidden Logic)
     * StorySteps: Sequential narrative steps for the case.	AnswerKeys: Contains the ExpectedResultHash and CanonicalQuery used by the Tutor Agent to validate student success.

---

7. **User Stories (Phase 1 MVP)**

| ID    | Focus Area     | Goal                                                    |
| ----- | -------------- | ------------------------------------------------------- |
| US-01 | Environment    | Establish .NET 9, SQL Server, and Ollama environment    |
| US-02 | Schema         | Provide a Schema Browser for students to inspect tables |
| US-03 | Execution      | Enable safe SQL execution via MCP with results grid     |
| US-04 | DB Agent       | AI explains schema in plain English                     |
| US-05 | Tutor Agent    | Compare student results to canonical results            |
| US-06 | Hints          | Provide multi-level Socratic hints                      |
| US-07 | Planner Agent  | Auto-generate solvable investigation cases              |
| US-08 | Enforcer Agent | Validate logical consistency of generated cases         |
| US-09 | Stabilization  | Code freeze, testing, and demo prep                     |
| US-10 | Presentation   | Final slide deck and demo delivery                      |


---

8. **Timeline (Development Roadmap)**
   The project follows a 10-week sequential roadmap, delivering one User Story per week.
   * Weeks 1-3 (Infrastructure): Domain Models, Database Layer setup, MCP Server integration.
   * Weeks 4-5 (Core Pipelines): Query Execution Pipeline, Schema Browser, Query Tutor comparison logic.
   * Weeks 6-7 (Tutoring & Logic): Hint Generation Pipeline, Case Management, SQL Enforcer logic.
   * Weeks 8-9 (Integration): Full Agent Orchestration, UI Polish, End-to-End Testing.
   * Week 10 (Finalizing): Documentation and Capstone Presentation.

---

9. **Risks and Mitigations**

| Risk                  | Impact                               | Risk Level | Mitigation Strategy                                                                                 |
| --------------------- | ------------------------------------ | ---------- | --------------------------------------------------------------------------------------------------- |
| Local LLM Performance | Slow response times or stalling      | Medium     | Use optimized models (Llama 3.1 8B), cache schema descriptions, set strict timeouts                 |
| MCP Complexity        | Integration failure blocking agents  | High       | Use proven C# SDK, prototype early (Week 2), isolate testing before agent integration               |
| AI Hallucination      | Agents generating invalid SQL        | Medium     | All AI output is validated by the SQL Enforcer before reaching the student; use read-only MCP tools |
| Unsolvable Cases      | Students stuck due to logical errors | High       | Strict IsSolvable validation by Enforcer; hard-code one fallback demo case                          |
| Environment Drift     | SQL Server version mismatches        | Low        | Provide a standardized .bak restore file and init-database.sql script                               |

---

10. **Deployment Plan**
    The deployment strategy focuses on local, offline capability to mirror the student's existing course environment.
    * Deployment Artifacts:
      * Database: DataQuest.bak or init-database.sql script.
      * Application: Self-contained .NET executable (DataQuest.exe).
      * AI Infrastructure: Local Ollama instance and compiled MCP Server binary.
    * Environment Strategy
      * Development: Local machine with full debugging tools.
      * Production (Student Laptop): Local installation. The app reads appsettings.json to connect to the local SQL instance.
      * Startup Sequence: Application validates DB connection $\rightarrow$ Checks MCP status $\rightarrow$ Verifies Ollama connectivity $\rightarrow$ Loads "Ready" state.
